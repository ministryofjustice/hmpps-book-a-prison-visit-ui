{% set govukRebrand = true %}
{% extends "govuk/template.njk" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "components/one_login_header/service-header.njk" import govukOneLoginServiceHeader %}
{% from "govuk/components/header/macro.njk" import govukHeader %}
{% from "govuk/components/service-navigation/macro.njk" import govukServiceNavigation %}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}

{% set navigationItems = [
  {
    href: paths.HOME,
    text: "Home",
    id: "home-link",
    active: true if activeLink == "home-link"
  },
  {
    href: paths.BOOKINGS.HOME,
    text: "Visits",
    id: "bookings-link",
    active: true if activeLink == "bookings-link"
  },
  {
    href: paths.VISITORS,
    text: "Visitors",
    id: "visitors-link",
    active: true if activeLink == "visitors-link"
  }
  ] if showOLServiceNav
%}
{% set serviceName = applicationName %}
{% set signOutLink = paths.SIGN_OUT %}

{% set bodyAttributes = {
  "data-matomo-site-id": matomoSiteId,
  "data-matomo-container-id": matomoContainerId
} %}

{% set bodyClasses = ("env--" + environmentName) if environmentName %}

{% block head %}
  {% if matomoEnabled and analyticsConsentGiven %}
    {% if matomoSiteId %}
      <!-- Matomo -->
      <script nonce="{{ cspNonce }}" data-test="matomo-analytics">
        var _paq = window._paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
          var u="{{ matomoUrl }}/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '{{ matomoSiteId }}']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
      </script>
      <!-- End Matomo Code -->
    {% endif %}

    {% if matomoContainerId %}
      <!-- Matomo Tag Manager -->
      <script nonce="{{ cspNonce }}" data-test="matomo-tag-manager">
        var _mtm = window._mtm = window._mtm || [];
        _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
        (function() {
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='{{ matomoUrl }}/js/container_{{ matomoContainerId }}.js'; s.parentNode.insertBefore(g,s);
        })();
      </script>
      <!-- End Matomo Tag Manager -->
    {% endif %}
  {% endif %}

  <link href="/assets/stylesheets/application.css?{{ version }}" rel="stylesheet"/>
{% endblock %}

{% block pageTitle -%}
  {{ "Error: " if errors | length }}{{ pageTitle + " - " if pageTitle }}{{ applicationName }} - GOV.UK
{%- endblock %}

{% block bodyStart %}
  {% if matomoEnabled and analyticsConsentGiven == undefined %}
    {%- include "partials/cookieBanner.njk" -%}
  {% endif %}
{% endblock %}

{% block header %}
{# If user authenticated then use GOVUK One Login Header; otherwise default header #}
{% if user and user.sub %}
  {{ govukOneLoginServiceHeader({ 
    rebrand: true, 
    signOutLink: signOutLink,
    oneLoginLink: oneLoginLink,
    serviceNavigationParams: {
      serviceName: serviceName,
      navigation: navigationItems
    }
  }) }}
{% else %}
  {{ govukHeader({
    rebrand: true,
    homepageUrl: "https://www.gov.uk"
  }) }}
  {{ govukServiceNavigation({
    serviceName: applicationName
  }) }}
{% endif %}
{% endblock %}

{% block beforeContent %}
  {{ govukPhaseBanner({
    tag: {
      text: "Beta"
    },
    attributes: {
      role: "complementary"
    },
    html: 'This is a new service â€“ your <a href="https://submit.forms.service.gov.uk/form/263703/visit-someone-in-prison/" target="_blank">feedback (opens in a new tab)</a> will help us to improve it.'
  }) }}

  {% if backLinkHref %}
    <div role="navigation">
      {{ govukBackLink({
        text: "Back",
        href: backLinkHref,
        attributes: { "data-test": "back-link" }
      }) }}
    </div>
  {% endif %}
{% endblock %}

{% block footer %}
  {% set footerLinks = [
    {
      href: paths.ACCESSIBILITY,
      text: "Accessibility"
    },
    {
      href: paths.COOKIES,
      text: "Cookies"
    },
    {
      href: paths.PRIVACY,
      text: "Privacy"
    },
    {
      href: paths.TERMS,
      text: "Terms and conditions"
    }
  ] %}

  {{ govukFooter({
    rebrand: true,
    meta: {
      items: [] if hideFooterLinks else footerLinks
    }
  }) }}
{% endblock %}

{% block bodyEnd %}
  {# Run JavaScript at end of the <body>, to avoid blocking the initial render. #}
  <script type="module" src="/assets/govukFrontendInit.js"></script>
  <script src="/assets/init-service-header.js"></script>
  <script src="/assets/cookieBanner.js"></script>
{% block pageScripts %}
{% endblock %}
{% endblock %}
